<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Heart Particles</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505; /* Màu nền tối sang trọng */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Ẩn video camera đi, chỉ lấy dữ liệu */
        #input_video {
            display: none;
        }

        canvas {
            display: block;
        }

        /* UI Control Panel */
        #ui-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10;
            transition: opacity 0.3s;
        }

        h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(90deg, #ff9a9e, #fecfef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .control-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        label {
            font-size: 14px;
            color: #ddd;
        }

        /* Custom Color Picker */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            background: none;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #fff;
            border-radius: 50%;
        }

        .status-text {
            font-size: 12px;
            color: #aaa;
            margin-top: 15px;
            line-height: 1.5;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 10px;
        }

        /* Loading & Status Indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4d6d;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 77, 109, 0.5);
            transition: opacity 0.5s;
        }

        #hand-status {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>

    <!-- Thư viện Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Thư viện MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <video id="input_video"></video>
    
    <div id="loading">Đang khởi động AI & 3D...</div>
    <div id="hand-status">Đang đợi camera...</div>

    <div id="ui-container">
        <h2>Heart Particles</h2>
        <div class="control-group">
            <label>Màu hạt:</label>
            <input type="color" id="colorPicker" value="#ff0055">
        </div>
        <div class="status-text">
            <b>Hướng dẫn:</b><br>
            - Đưa 2 tay lên camera.<br>
            - <b>Gần nhau:</b> Trái tim thu gọn.<br>
            - <b>Xa nhau:</b> Hạt mở rộng/nổ tung.
        </div>
    </div>

    <script>
        // --- 1. CẤU HÌNH THREE.JS ---
        const scene = new THREE.Scene();
        // Sương mù để tạo chiều sâu
        scene.fog = new THREE.FogExp2(0x050505, 0.002);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 40;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- 2. TẠO HÌNH TRÁI TIM 3D (PARTICLES) ---
        const particleCount = 6000; // Số lượng hạt
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const originalPositions = new Float32Array(particleCount * 3); // Lưu vị trí gốc (hình tim)
        const randomness = new Float32Array(particleCount * 3); // Hướng ngẫu nhiên khi nổ

        // Hàm toán học tạo hình trái tim 3D
        // x = 16sin^3(u)
        // y = 13cos(u) - 5cos(2u) - 2cos(3u) - cos(4u)
        // z = độ dày
        for (let i = 0; i < particleCount; i++) {
            // u chạy từ 0 đến PI*2, v để tạo độ dày 3D
            const u = Math.random() * Math.PI * 2;
            const v = Math.random() * Math.PI; 

            // Công thức trái tim 3D tham số hóa
            // Scale nhỏ lại (0.5) để vừa màn hình
            const r = 0.5;
            
            // Tính toán vị trí x, y, z tạo nên lớp vỏ trái tim
            const x = r * 16 * Math.pow(Math.sin(u), 3) * Math.sin(v);
            const y = r * (13 * Math.cos(u) - 5 * Math.cos(2 * u) - 2 * Math.cos(3 * u) - Math.cos(4 * u));
            const z = r * 6 * Math.cos(u) * Math.sin(v); // Tạo độ dày

            // Gán vị trí
            const i3 = i * 3;
            positions[i3] = x;
            positions[i3 + 1] = y;
            positions[i3 + 2] = z;

            // Lưu vị trí gốc
            originalPositions[i3] = x;
            originalPositions[i3 + 1] = y;
            originalPositions[i3 + 2] = z;

            // Tạo vector ngẫu nhiên để dùng khi mở rộng (hiệu ứng nổ)
            // Hạt sẽ bay ra xa tâm theo hướng ngẫu nhiên
            randomness[i3] = (Math.random() - 0.5) * 40;
            randomness[i3 + 1] = (Math.random() - 0.5) * 40;
            randomness[i3 + 2] = (Math.random() - 0.5) * 40;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        // Texture cho hạt (vẽ trực tiếp bằng code để không cần load ảnh)
        const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');

        const material = new THREE.PointsMaterial({
            color: 0xff0055,
            size: 0.4,
            map: sprite,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending, // Giúp hạt phát sáng khi chồng lên nhau
            depthWrite: false
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // --- 3. LOGIC ĐIỀU KHIỂN & SỰ KIỆN ---
        
        let targetScale = 1.0; // Mức độ mở rộng mục tiêu
        let currentScale = 1.0; // Mức độ hiện tại (để animation mượt)
        const statusDiv = document.getElementById('hand-status');
        const loadingDiv = document.getElementById('loading');

        // Đổi màu hạt
        document.getElementById('colorPicker').addEventListener('input', (e) => {
            particles.material.color.set(e.target.value);
        });

        // Resize màn hình
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- 4. TÍCH HỢP MEDIAPIPE (NHẬN DIỆN TAY) ---
        
        const videoElement = document.getElementById('input_video');

        function onResults(results) {
            loadingDiv.style.opacity = 0; // Ẩn loading

            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                // Đã phát hiện 2 bàn tay
                statusDiv.innerText = "Đã kết nối 2 tay";
                statusDiv.style.color = "#00ff88";
                statusDiv.style.borderColor = "#00ff88";

                // Lấy tọa độ cổ tay (wrist - điểm số 0) của 2 tay
                const hand1 = results.multiHandLandmarks[0][0];
                const hand2 = results.multiHandLandmarks[1][0];

                // Tính khoảng cách Euclidean
                const dx = hand1.x - hand2.x;
                const dy = hand1.y - hand2.y;
                const distance = Math.sqrt(dx*dx + dy*dy);

                // Map khoảng cách (0.1 -> 0.7) sang scale (1 -> 5)
                // Khoảng cách càng lớn, scale càng to
                // Hệ số nhân và cộng trừ điều chỉnh theo thực tế camera
                let factor = (distance - 0.15) * 10;
                
                if (factor < 1) factor = 1; // Tối thiểu là hình tim gốc
                if (factor > 6) factor = 6; // Giới hạn tối đa

                targetScale = factor;

            } else if (results.multiHandLandmarks && results.multiHandLandmarks.length === 1) {
                statusDiv.innerText = "Cần thêm 1 tay nữa...";
                statusDiv.style.color = "#ffcc00";
                statusDiv.style.borderColor = "#ffcc00";
                targetScale = 1.0;
            } else {
                statusDiv.innerText = "Không tìm thấy tay";
                statusDiv.style.color = "#fff";
                statusDiv.style.borderColor = "rgba(255,255,255,0.1)";
                targetScale = 1.0;
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        cameraUtils.start();

        // --- 5. ANIMATION LOOP ---

        // Hàm làm mượt (Linear Interpolation)
        function lerp(start, end, amt) {
            return (1 - amt) * start + amt * end;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Làm mượt giá trị scale
            currentScale = lerp(currentScale, targetScale, 0.08);

            // Xoay nhẹ khối hạt để tạo hiệu ứng 3D
            particles.rotation.y += 0.005;

            // Cập nhật vị trí từng hạt
            const positionsAttribute = particles.geometry.attributes.position;
            const array = positionsAttribute.array;

            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                const ox = originalPositions[i3];
                const oy = originalPositions[i3 + 1];
                const oz = originalPositions[i3 + 2];

                const rx = randomness[i3];
                const ry = randomness[i3 + 1];
                const rz = randomness[i3 + 2];

                // Logic biến đổi hình dạng:
                // Nếu scale gần 1 (tay gần nhau): Giữ nguyên hình trái tim (ox, oy, oz)
                // Nếu scale lớn (tay xa nhau): Cộng thêm độ nhiễu (rx, ry, rz) để tạo hiệu ứng nổ
                
                const expansionAmount = currentScale - 1; // 0 nếu ở trạng thái gốc
                
                // Vị trí mới = (Vị trí gốc * scale) + (Nhiễu * mức độ mở rộng)
                array[i3]     = ox * currentScale + rx * expansionAmount * 0.5;
                array[i3 + 1] = oy * currentScale + ry * expansionAmount * 0.5;
                array[i3 + 2] = oz * currentScale + rz * expansionAmount * 0.5;
            }

            positionsAttribute.needsUpdate = true;
            renderer.render(scene, camera);
        }

        animate();

    </script>
</body>
</html>